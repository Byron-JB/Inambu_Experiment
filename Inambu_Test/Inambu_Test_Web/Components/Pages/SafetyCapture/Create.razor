@page "/SafetyCapture/Create"

@rendermode InteractiveServer
@using Application.Features.Commands
@using Application.Models.DTO
@inject MediatR.IMediator _mediator
@inject IJSRuntime JsRuntime
@inject IHttpContextAccessor HttpContextAccessor
@inject Inambu_Test_Web.Services.CookieService _cookieService
@inject NavigationManager NavigationManager


<h3>SafetyCapture</h3>

<EditForm Model="@measurementCaptureDTO" OnValidSubmit="HandleValidSubmit" FormName="test6">
    <DataAnnotationsValidator />
    <ValidationSummary />
    
    <div>
        <label>Production Line</label>
        <InputSelect @bind-Value="measurementCaptureDTO.ProductionLineID">
            <option value="">-- Select --</option>

            @if (availableProductionLines != null)
            {
                @foreach (var prodLine in availableProductionLines)
                {
                    if (prodLine != null)
                    {
                        <option value="@prodLine!.ProductionLineId">@prodLine.ProductionLineName</option>
                    }
                }
            }
        </InputSelect>
    </div>
    <div>
        <label>Temperature</label>
        <InputNumber @bind-Value="measurementCaptureDTO.Temperature" class="form-control" />
    </div>

    <div>
        <label>Humidity</label>
        <InputNumber @bind-Value="measurementCaptureDTO.Humidity" class="form-control" />
    </div>

    <div>
        <label>Weight</label>
        <InputNumber @bind-Value="measurementCaptureDTO.Weight" class="form-control" />
    </div>

    <div>
        <label>Width</label>
        <InputNumber @bind-Value="measurementCaptureDTO.Width" class="form-control" />
    </div>

    <div>
        <label>Length</label>
        <InputNumber @bind-Value="measurementCaptureDTO.Length" class="form-control" />
    </div>

    <div>
        <label>Depth</label>
        <InputNumber @bind-Value="measurementCaptureDTO.Depth" class="form-control" />
    </div>

    <div>
        <label>Is Within Specification</label>
        <InputCheckbox @bind-Value="measurementCaptureDTO.IsWithinSpecification" />
    </div>

    <button type="submit" class="btn btn-primary">Submit</button>
</EditForm>

@code {
    private MeasurementCaptureDTO measurementCaptureDTO = new MeasurementCaptureDTO();
    private List<ProductionLineDTO?> availableProductionLines = new List<ProductionLineDTO?>();

    private async Task HandleValidSubmit()
    {
        try
        {

            HttpContextAccessor.HttpContext?.Request.Cookies.TryGetValue("userName", out string? userNameFromCookie);

            measurementCaptureDTO.UserId = _cookieService.GetUserIdFromCookie() ?? 0;
            var result = await _mediator.Send(new CreateMeasurementReadingCommand(measurementCaptureDTO));

            if (result.IsSuccess)
            {
                NavigationManager.NavigateTo("/SafetyCapture/ViewAll");
            }
            // Log or show result; handler currently returns CommandResult
            //statusMessage = result?.Success == true ? "Submitted successfully." : $"Submit failed: {result?.Message ?? "unknown"}";
            await JsRuntime.InvokeVoidAsync("console.log", result);
        }
        catch (Exception ex)
        {
            //await JsRuntime.InvokeVoidAsync("console.error", ex.Message);
        }
    }

    private async Task LoadProductionLines()
    {
        var productionLineQuery = new Application.Features.Queries.GetProductionListQuery();
        availableProductionLines = await _mediator.Send(productionLineQuery);
    }

    private void HandleSelectionChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int selectedId))
        {
            measurementCaptureDTO.ProductionLineID = selectedId;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProductionLines();
    }

}