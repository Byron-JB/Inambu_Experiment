@page "/SafetyCapture"
@rendermode InteractiveServer
@using Application.DTO
@using Application.Features.Commands
@using Application.Models.DTO
@inject MediatR.IMediator _mediator
@inject IJSRuntime JsRuntime

<h3>SafetyCapture</h3>

<EditForm Model="@safetyCaptureDTO" OnValidSubmit="HandleValidSubmit" FormName="test6" >
    <DataAnnotationsValidator />
    <ValidationSummary />
    
    <div>
        <label>Production Line</label>
        <InputSelect @bind-Value="safetyCaptureDTO.ProductionLineID">
            <option value="">-- Select --</option>

            @if (availableProductionLines != null)
            {
                @foreach (var prodLine in availableProductionLines)
                {
                    if (prodLine != null)
                    {
                        <option value="@prodLine!.ProductionLineId">@prodLine.ProductionLineName</option>
                    }
                }
            }
        </InputSelect>
    </div>
    <div>
        <label>Temperature</label>
        <InputNumber @bind-Value="safetyCaptureDTO.Temperature" @bind-Value:event="oninput" class="form-control" />
    </div>

    <div>
        <label>Humidity</label>
        <InputNumber @bind-Value="safetyCaptureDTO.Humidity" class="form-control" />
    </div>

    <div>
        <label>Weight</label>
        <InputNumber @bind-Value="safetyCaptureDTO.Weight" class="form-control" />
    </div>

    <div>
        <label>Width</label>
        <InputNumber @bind-Value="safetyCaptureDTO.Width" class="form-control" />
    </div>

    <div>
        <label>Length</label>
        <InputNumber @bind-Value="safetyCaptureDTO.Length" class="form-control" />
    </div>

    <div>
        <label>Depth</label>
        <InputNumber @bind-Value="safetyCaptureDTO.Depth" class="form-control" />
    </div>

    <div>
        <label>Is Within Specification</label>
        <InputCheckbox @bind-Value="safetyCaptureDTO.IsWithinSpecification" />
    </div>

    <button type="submit" class="btn btn-primary">Submit</button>
</EditForm>

@code {
    private SafetyCaptureDTO safetyCaptureDTO = new SafetyCaptureDTO();
    private List<ProductionLineDTO?> availableProductionLines = new List<ProductionLineDTO?>();

    private async Task HandleValidSubmit()
    {
        try
        {
            var result = await _mediator.Send(new CreateSafetyReadingCommand(safetyCaptureDTO));
            // Log or show result; handler currently returns CommandResult
            //statusMessage = result?.Success == true ? "Submitted successfully." : $"Submit failed: {result?.Message ?? "unknown"}";
            await JsRuntime.InvokeVoidAsync("console.log", result);
        }
        catch (Exception ex)
        {
            //await JsRuntime.InvokeVoidAsync("console.error", ex.Message);
        }
    }

    private async Task LoadProductionLines()
    {
        var productionLineQuery = new Application.Features.Queries.GetProductionListQuery();
        availableProductionLines = await _mediator.Send(productionLineQuery);
    }

    private void HandleSelectionChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int selectedId))
        {
            safetyCaptureDTO.ProductionLineID = selectedId;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProductionLines();
    }
}